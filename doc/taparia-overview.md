# Структура проекта

## Документация

Директория `doc` была создана для хранения в ней всякого рода документации. В данный момент там лежит какая-то моя шиза, не представляющая особой ценности. Если тебе захочется что-то пописать, пока будешь изучать проект, то feel free добавить в нее какие-нибудь свои заметки. Также заметки можно писать в тикетах (issues), их тоже свободно создавать, не стесняться.

## Сheckstyle на страже порядка

Ты можешь заметить файлы `checkstyle.xml` и `checkstyle-suppressions.xml`. Это конфигурации утилиты `checkstyle` -- системе автоматической проверки качества кода. В первом описаны правила, которым должен соотвествовать код, а во втором исключения из них (например, `checkstyle` не понимает `lombok`). Проверка кода на качество встроена в процесс сборки и не позволит собрать проект, не удовлетворяющий описанным требованиям по стилю кода и форматированию.

## Пародия на интеграционные тесты

В папке `test` лежит скриптик для автоматического тестирования работоспособности Public API. Сам скрипт можно запускать при старте приложения, но учитывайте, что он не откатывает внесенные собой изменения. Также рядышком json файл с примером фигуры, которую можно попробовать создать, когда зайдешь на сайтик. 

## Модули

Рассказ буду вести снизу вверх. 
Вообще, архитектура у проекта трехслойная:
```
API --> Service --> Storage
```

`API` - то, с чем взаимодействует внешний клиент, в `app` - `JSF`, а в `api` - JAX-RS эндпоинты.
`Service` - слой с бизнес-логикой, скрытый от клиента, тут мы получаем данные и хранилища и как-то особенно их обрабатываем.
`Storage` - слой хранения данных, здесь и только здесь происходит взаимодействие с базой данных.

### Storage

Модуль содержит интерфейсы третьего слоя - слоя хранения данных. Нужен для создания абстракции. Слои, зависимые от слоя хранения данных (сервисы), используют классы именно из этого пакета, ничего не подозревая о реализации, чтобы можно было легко сменить `postgres` на другую `SQL` базу данных, либо вообще на какой-нибудь Key-Value Storage.

### Storage JDBC

Реализация слоя хранения данных с помощью `jdbc` и библиотеки `JOOQ`. `JOOQ` позволяет очень удобно и compile-time-безопасно (почти) генерировать SQL запросы, а также генерирует java код сущностей в базе данных, очень удобно. Также в этом пакете, кажется, лежат миграции на базу данных (создание и изменение схемы данных), мигратор - `liquibase`. SQL файл можно найти в `resources`.

### Model

Содержит доменные сущности сервиса, то есть главные объекты, которыми ми оперируем - картинка, фигура, аккаунт пользователя, тыка-тык. Содержание - как бы основные термины нашей системы.

### Logic

Тут вся бизнес-логика, интерфейсы сервисов и их реализации.

### Commons.Logging

Вспомогательные классы для логирования, видимо, я не помню. Было бы неплохо сделать какой-нибудь пакетик `observability`, наверное, в который положить `logging` и `metrics` (вроде, в следующей лабе будет).

### Backend

Содержит солидную сущность - весь бэкенд нашего приложения. Преднозначение этого ядра -- поднять все компоненты системы, связать их друг с другом, подключиться к БД, накатить миграцию, в общем, эта штука запускает всю махину. От нее зависят `app` и `api`, так как используют его как мозг, в то время как сами просто принимают запросы, конвертируют данные в `model` - язык, на котором говорит наша бизнес-логика, и просит бэкенд порешать все вопросики. Так как приложение `stateless`, можно поднять сразу 2 независимых `Backend`'a и быть счастливым.

### Model Serialize

Описание сущностей, которые мы отдаем пользователю по `HTTP API`. Сущности, отдаваемые пользователю не должны быть классами из пакета `model`, так как за счет этого по задумке автора достигается `decoupling` и повышается безопасность (не покажем лишнего), а еще просто Jackson аннотациям не место в модели. Также этот модуль используется в `storage-jdbc` для записи фигур в соответствующую колонку таблицы бд прямо в формате json.

### Application

Сервис, поддерживающий работу сайта. Он раздает js, html и css для работы основного раздела приложения. Также в нем есть `JSF` контроллер, отвечающий да форму логина и регистрации на портале. Контроллер использует `Backend`.

### Public API

`REST API` поддерживающий веб-сайт. Фронтэнд, будучи запущенным в браузере конечного пользователя является клиентом нашей системы и взаимодействует с ней средствами протокола `HTTP`. Реализовано с помощью компонента `Jakarta EE` - `JAX-RS`, штука похожая на `Spring Web`. В наличии множество роутов, с ними можно ознакомиться, посмотрев в исходный код `taparia-api`, а также реализации клиента на `TS`, который можно найти в папке с фронтэндом, лежащей в `taparia-app` в `webapp`. Как уже было сказано, использует `Backend`. Для (де)сериализации запросов и ответов используется `Jackson`.


## Docker - кит, на котором держится бэк

После сборки проекта командой `mvn build` мы получим два `war`- архива, которые мы и будем деплоить на `wildfly`. `Dockerfile` - по сути, просто надстройка над стандартным образом вайлдфлая, но с добавлением лишь того, что мы заранее создаем там пользователя и деплоим в него наши варники `app.war` и `api.war`, открываем порты для работы сервера. В `docker-compose` описано примерно следующее: поднимем нашу тапарию и ее базу данных и поместим их в единую сеть, чтобы они могли общаться друг с другом.

## Makefile или как собрать и запустить проект

Мейкфайл -- точка входа в сборку и деплой. Все делается через него.

Просто собрать оба артефакта (в `app` нужно еще скомпилировать `TypeScript`):

```bash
make wars
```

Собрать проект и поднять всю инфраструктуру локально в контейнере:

```bash
make infra
```

Убить контейнер, а вместе с ним и приложение:

```bash
make infra-stop
```

## Что нужно для сборки

- `make`
- `docker`
- `maven`
- `java 17`
- `npm`

## Заметки

В приложении присутствует самописная аутентификация и авторизация клиентов. Ключи доступа - просто рандомная строка заданной длины. Естественно ни о какой безопасности речи не идёт, все кидаем по незашифрованному `HTTP`.

Для удобства и чистоты используется библиотека `lombok`, которая генерирует различный `boilerplate` код, например, геттеры, билдеры, toString, hashCode, equals, а также конструкторы.

Использование сеттеров в проекте запрещено. Стараемся придерживаться философии Егора Бугаенко. Также лучше использовать типобезопасные обертки над примитивами.
